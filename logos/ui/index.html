<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGNUM OPS | CONTROL CENTER</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Courier New', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        .logo { font-size: 24px; font-weight: bold; color: #58a6ff; }
        .status { font-size: 14px; }
        .status.online { color: #3fb950; }
        .status.offline { color: #f85149; }
        .main-container { display: flex; flex: 1; gap: 20px; }
        #chart-container { flex: 1; border: 1px solid #30363d; border-radius: 6px; position: relative; }
        .controls { width: 300px; background: #161b22; padding: 20px; border-radius: 6px; border: 1px solid #30363d; display: flex; flex-direction: column; gap: 20px; }
        .control-group { display: flex; flex-direction: column; gap: 10px; }
        label { font-size: 12px; text-transform: uppercase; color: #8b949e; }
        
        .btn { width: 100%; padding: 20px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; border: 1px solid; margin-bottom: 15px; border-radius: 4px; }
        
        .nuke-btn { background: #21262d; color: #f85149; border-color: #f85149; }
        .nuke-btn:hover { background: #f85149; color: #fff; box-shadow: 0 0 20px rgba(248, 81, 73, 0.6); }
        .nuke-btn.active { background: #f85149; color: #fff; animation: pulse 1s infinite; }
        .nuke-btn.processing { background: #d29922; color: #fff; cursor: wait; opacity: 0.8; }
        
        /* –ö–Ω–æ–ø–∫–∞ –°–∫–∞—á–∞—Ç—å (–ö—Ä–∞—Å–Ω–∞—è/–î–µ—Ñ–æ–ª—Ç) */
        .pdf-btn { background: #21262d; color: #58a6ff; border-color: #58a6ff; display: none; } /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        .pdf-btn:hover { background: #1f6feb; color: #fff; box-shadow: 0 0 20px rgba(88, 166, 255, 0.6); }
        
        /* –ö–Ω–æ–ø–∫–∞ –ò–Ω–≤–µ—Å—Ç–æ—Ä–∞ (–ó–µ–ª–µ–Ω–∞—è) */
        .investor-btn { background: #238636; color: #fff; border-color: #238636; display: none; animation: glow 2s infinite; }
        .investor-btn:hover { background: #2ea043; box-shadow: 0 0 25px rgba(46, 160, 67, 0.8); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes glow { 0% { box-shadow: 0 0 10px rgba(46, 160, 67, 0.5); } 50% { box-shadow: 0 0 25px rgba(46, 160, 67, 0.9); } 100% { box-shadow: 0 0 10px rgba(46, 160, 67, 0.5); } }
        
        .log-console { flex: 1; background: #000; border: 1px solid #30363d; padding: 10px; font-size: 12px; overflow-y: auto; color: #7ee787; font-family: monospace; }
        .log-entry { margin-bottom: 4px; }
        .log-entry.poison { color: #f85149; font-weight: bold; }
        
        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background-color: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 30px; width: 400px; text-align: center; position: relative; box-shadow: 0 0 50px rgba(46, 160, 67, 0.3); }
        .close { position: absolute; top: 10px; right: 15px; color: #8b949e; font-size: 24px; cursor: pointer; }
        .close:hover { color: #fff; }
        .modal h2 { color: #3fb950; margin-top: 0; }
        .modal p { color: #c9d1d9; font-size: 14px; line-height: 1.5; }
        .modal input { width: 100%; padding: 12px; margin: 15px 0; background: #0d1117; border: 1px solid #30363d; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .modal button { width: 100%; padding: 12px; background: #238636; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .modal button:hover { background: #2ea043; }
        #form-status { margin-top: 15px; font-size: 13px; color: #3fb950; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">MAGNUM OPS // CONTROL CENTER</div>
        <div class="status" id="connection-status">DISCONNECTED</div>
    </div>
    <div class="main-container">
        <div id="chart-container"></div>
        <div class="controls">
            <div class="control-group">
                <label>Chaos Control</label>
                <button class="btn nuke-btn" id="nuke-btn">ACTIVATE CRASH</button>
            </div>
            
            <div class="control-group">
                <label>Results</label>
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–µ—É–¥–∞—á–Ω–∏–∫–æ–≤ (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ) -->
                <button class="btn pdf-btn" id="pdf-btn" onclick="downloadLatestReport()">üìÑ DOWNLOAD CRASH REPORT</button>
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (–ü–ª–∞—Ç–Ω–∞—è) -->
                <button class="btn investor-btn" id="investor-btn" onclick="openModal()">üèÜ GET INVESTOR CERTIFICATE ($49)</button>
            </div>

            <div class="control-group">
                <label>System Logs</label>
                <div class="log-console" id="log-console">
                    <div class="log-entry">> System initialized...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEAD CAPTURE MODAL -->
    <div id="paywall-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üíπ TEST PASSED!</h2>
            <p>Your bot successfully survived the stress test.<br>This qualifies you for the <b>Magnum Certified</b> badge.</p>
            <p style="font-size: 12px; color: #8b949e;">Price: $49.00 (One-time fee)</p>
            
            <form id="cert-form" onsubmit="submitForm(event)">
                <input type="email" id="email" name="email" placeholder="Enter your email address" required>
                <button type="submit">REQUEST CERTIFICATE</button>
            </form>
            <div id="form-status"></div>
        </div>
    </div>

    <script>
        var chaosActive = false;
        var socket;
        var latestReportUrl = null;
        
        const statusDiv = document.getElementById('connection-status');
        const logConsole = document.getElementById('log-console');
        const nukeBtn = document.getElementById('nuke-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const investorBtn = document.getElementById('investor-btn');
        const modal = document.getElementById('paywall-modal');
        const chartContainer = document.getElementById('chart-container');

        const chart = LightweightCharts.createChart(chartContainer, {
            layout: { background: { type: 'solid', color: '#0d1117' }, textColor: '#c9d1d9' },
            grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
            timeScale: { timeVisible: true, secondsVisible: true },
        });
        const candleSeries = chart.addCandlestickSeries({ upColor: '#3fb950', downColor: '#f85149', borderVisible: false, wickUpColor: '#3fb950', wickDownColor: '#f85149' });

        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== chartContainer) { return; }
            const newRect = entries[0].contentRect;
            chart.applyOptions({ width: newRect.width, height: newRect.height });
        }).observe(chartContainer);

        function log(text, isPoison = false) {
            const div = document.createElement('div');
            div.className = 'log-entry' + (isPoison ? ' poison' : '');
            div.innerText = text;
            logConsole.prepend(div);
            if (logConsole.children.length > 50) logConsole.lastElementChild.remove();
        }

        async function toggleChaos() {
            chaosActive = !chaosActive;
            
            if (chaosActive) {
                nukeBtn.innerText = "DEACTIVATE CRASH";
                nukeBtn.classList.add('active');
                // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
                pdfBtn.style.display = 'none';
                investorBtn.style.display = 'none';
                log("> CHAOS ACTIVE");
            } else {
                nukeBtn.innerText = "ANALYZING...";
                nukeBtn.classList.remove('active');
                nukeBtn.classList.add('processing');
                log("> GENERATING VERDICT...");
            }
            
            try {
                const res = await fetch('/control/chaos', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ active: chaosActive }) 
                });
                const data = await res.json();
                
                if (!chaosActive) {
                    nukeBtn.classList.remove('processing');
                    nukeBtn.innerText = "ACTIVATE CRASH";
                    
                    // –õ–û–ì–ò–ö–ê FREEMIUM
                    if (data.paywall === true) {
                        // –ó–ï–õ–ï–ù–´–ô (–ü–õ–ê–¢–ù–´–ô)
                        log("> [SUCCESS] BOT SURVIVED! Anomalies within limits.");
                        investorBtn.style.display = 'block';
                    } else if (data.report_ready) {
                        // –ö–†–ê–°–ù–´–ô (–ë–ï–°–ü–õ–ê–¢–ù–´–ô)
                        latestReportUrl = data.report_url;
                        pdfBtn.style.display = 'block';
                        log("> [FAILURE] LIQUIDATION DETECTED. Report generated.");
                    }
                }
            } catch (e) { 
                log(`> ERROR: ${e}`); 
                nukeBtn.classList.remove('processing');
                nukeBtn.innerText = "ACTIVATE CRASH";
            }
        }
        nukeBtn.addEventListener('click', toggleChaos);

        async function downloadLatestReport() {
            if (latestReportUrl) window.open(latestReportUrl, '_blank');
        }

        // --- MODAL LOGIC ---
        function openModal() { modal.style.display = "flex"; }
        function closeModal() { modal.style.display = "none"; document.getElementById('form-status').innerText = ''; }
        
        async function submitForm(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const status = document.getElementById('form-status');
            status.innerText = "Sending request...";
            
            try {
                const response = await fetch("https://formspree.io/f/mnnykvry", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, subject: "Magnum Investor Certificate Request" })
                });
                
                if (response.ok) {
                    status.innerText = "Request received! We will contact you shortly.";
                    document.getElementById('cert-form').reset();
                    setTimeout(closeModal, 3000);
                } else {
                    status.innerText = "Error sending request. Try again.";
                }
            } catch (error) {
                status.innerText = "Network error.";
            }
        }

        // Websocket
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${protocol}://${window.location.host}/ws`;
        function connect() {
            socket = new WebSocket(wsUrl);
            socket.onopen = () => { statusDiv.innerText = "SYSTEM ONLINE"; statusDiv.classList.add('online'); statusDiv.classList.remove('offline'); };
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'CANDLE_UPDATE') {
                    const c = msg.data;
                    candleSeries.update({ time: c.time / 1000, open: c.open, high: c.high, low: c.low, close: c.close });
                    if (c.is_poisoned) log(`> CRASH DATA: ${c.close}`, true);
                }
            };
            socket.onclose = () => { statusDiv.innerText = "RECONNECTING..."; statusDiv.classList.add('offline'); statusDiv.classList.remove('online'); setTimeout(connect, 3000); };
        }
        connect();
    </script>
</body>
</html>
